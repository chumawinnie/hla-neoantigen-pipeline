# Output Documentation

This document describes the output files generated by the neoantigen prediction pipeline.

## Directory Structure

```
results/
├── {sample_id}/
│   ├── hla_reads/
│   ├── hla_typing/
│   ├── annotation/
│   ├── neoantigens/
│   └── report/
├── multiqc/
└── pipeline_info/
```

## Per-Sample Outputs

### HLA Reads (`hla_reads/`)

Extracted reads from the HLA region for HLA typing.

| File | Description |
|------|-------------|
| `{sample}_hla_R1.fastq.gz` | Forward reads from HLA region |
| `{sample}_hla_R2.fastq.gz` | Reverse reads from HLA region |
| `{sample}_extract_hla.log` | Extraction statistics |

### HLA Typing (`hla_typing/`)

#### Class I (`class_i/`)

| File | Description |
|------|-------------|
| `{sample}_optitype_result.tsv` | OptiType HLA-A, -B, -C calls |
| `{sample}_optitype_coverage.pdf` | Coverage plot across HLA alleles |

**OptiType Result Format:**
```
	A1	A2	B1	B2	C1	C2	Reads	Objective
0	A*02:01	A*03:01	B*07:02	B*44:02	C*05:01	C*07:02	1234	0.987
```

#### Class II (`class_ii/`)

| File | Description |
|------|-------------|
| `{sample}_hlahd_result.txt` | HLA-HD full HLA typing results |

**HLA-HD Result Format:**
```
HLA-A	A*02:01:01	A*03:01:01
HLA-B	B*07:02:01	B*44:02:01
HLA-C	C*05:01:01	C*07:02:01
HLA-DRB1	DRB1*15:01:01	DRB1*04:01:01
HLA-DQB1	DQB1*06:02:01	DQB1*03:02:01
HLA-DPB1	DPB1*04:01:01	DPB1*02:01:02
```

#### Merged Results

| File | Description |
|------|-------------|
| `{sample}_hla_alleles.txt` | Combined alleles for pVACseq (comma-separated) |
| `{sample}_hla_summary.json` | Structured JSON summary |

**HLA Alleles Format (for pVACseq):**
```
HLA-A*02:01,HLA-A*03:01,HLA-B*07:02,HLA-B*44:02,HLA-C*05:01,HLA-C*07:02,HLA-DRB1*15:01,HLA-DRB1*04:01,HLA-DQB1*06:02,HLA-DQB1*03:02
```

### Annotation (`annotation/`)

| File | Description |
|------|-------------|
| `{sample}.vep.vcf.gz` | VEP-annotated VCF |
| `{sample}.vep.vcf.gz.tbi` | Tabix index |
| `{sample}_vep_summary.html` | VEP annotation statistics |

### Neoantigens (`neoantigens/`)

#### pVACseq Output (`{sample}_pvacseq/`)

```
{sample}_pvacseq/
├── MHC_Class_I/
│   ├── {sample}.all_epitopes.tsv
│   ├── {sample}.filtered.tsv
│   └── {sample}.all_epitopes.aggregated.tsv
└── MHC_Class_II/
    ├── {sample}.all_epitopes.tsv
    ├── {sample}.filtered.tsv
    └── {sample}.all_epitopes.aggregated.tsv
```

#### Key Column Descriptions

| Column | Description |
|--------|-------------|
| `Chromosome` | Variant chromosome |
| `Start` | Variant start position |
| `Stop` | Variant end position |
| `Reference` | Reference allele |
| `Variant` | Alternate allele |
| `Gene Name` | Gene symbol |
| `Mutation` | Protein change (e.g., p.V600E) |
| `HGVSc` | HGVS coding notation |
| `HGVSp` | HGVS protein notation |
| `HLA Allele` | Predicted HLA allele |
| `MT Epitope Seq` | Mutant peptide sequence |
| `WT Epitope Seq` | Wildtype peptide sequence |
| `Median MT IC50 Score` | Predicted binding affinity (nM) |
| `Median WT IC50 Score` | Wildtype binding affinity |
| `Median MT Percentile` | Binding percentile rank |
| `Tumor DNA VAF` | Variant allele frequency |

#### Filtered Results

| File | Description |
|------|-------------|
| `{sample}_neoantigens_filtered.tsv` | Candidates passing thresholds |
| `{sample}_neoantigens_ranked.tsv` | Priority-ranked candidates |
| `{sample}_neoantigen_summary.json` | Summary statistics |

**Summary JSON Format:**
```json
{
  "sample_id": "PATIENT001",
  "total_predictions": 1234,
  "filtered_count": 45,
  "class_i_count": 38,
  "class_ii_count": 7,
  "filtering_criteria": {
    "binding_threshold": 500,
    "percentile_threshold": 2,
    "min_vaf": 0.05
  },
  "top_candidates": [
    {
      "gene": "KRAS",
      "mutation": "p.G12D",
      "peptide": "VVVGADGVGK",
      "hla_allele": "HLA-A*11:01",
      "ic50": 45.2,
      "percentile": 0.15,
      "priority_score": 85
    }
  ]
}
```

### Clinical Report (`report/`)

| File | Description |
|------|-------------|
| `{sample}_neoantigen_report.html` | Clinical summary for MTB |

The HTML report includes:
- HLA typing summary
- Neoantigen statistics
- Top ranked candidates table
- Methods description

## Aggregate Outputs

### MultiQC (`multiqc/`)

| File | Description |
|------|-------------|
| `multiqc_report.html` | Aggregated QC report |
| `multiqc_data/` | Parsed data files |

### Pipeline Info (`pipeline_info/`)

| File | Description |
|------|-------------|
| `execution_report.html` | Resource usage summary |
| `execution_timeline.html` | Process timeline |
| `execution_trace.txt` | Detailed trace log |
| `pipeline_dag.svg` | Workflow DAG visualization |

## Interpreting Results

### Neoantigen Priority Score

The priority score (0-100) combines multiple factors:

| Score Range | Interpretation |
|-------------|----------------|
| ≥70 | **High priority** - Strong binding, high immunogenicity potential |
| 40-69 | **Medium priority** - Good candidates for further validation |
| <40 | **Lower priority** - May still be relevant in specific contexts |

### Binding Affinity Interpretation

| IC50 (nM) | Classification |
|-----------|----------------|
| <50 | Strong binder |
| 50-150 | Moderate binder |
| 150-500 | Weak binder |
| >500 | Non-binder |

### Percentile Rank

| %Rank | Interpretation |
|-------|----------------|
| <0.5 | Top binders |
| 0.5-1 | Strong binders |
| 1-2 | Good binders |
| >2 | Weak/non-binders |

### Differential Agretopicity Index (DAI)

The ratio of wildtype to mutant binding indicates tumor specificity:

| WT/MT Ratio | Interpretation |
|-------------|----------------|
| >10 | Highly tumor-specific |
| 5-10 | Tumor-specific |
| 2-5 | Moderately specific |
| <2 | Low specificity |

## Using Results

### For MTB Presentations

Use `{sample}_neoantigen_report.html` directly in molecular tumor board discussions.

### For Downstream Analysis

```python
import pandas as pd

# Load ranked neoantigens
df = pd.read_csv('results/PATIENT001/neoantigens/PATIENT001_neoantigens_ranked.tsv', sep='\t')

# Filter high-priority candidates
high_priority = df[df['Priority_Score'] >= 70]

# Get unique genes with neoantigens
genes_with_neoantigens = df['Gene Name'].unique()
```

### For Vaccine Design

Export top candidates for peptide synthesis:

```python
# Get top 20 candidates
top_candidates = df.head(20)

# Export peptide sequences
top_candidates[['Gene Name', 'Mutation', 'MT Epitope Seq', 'HLA Allele', 'Median MT IC50 Score']].to_csv(
    'top_neoantigens_for_vaccine.csv', index=False
)
```

## Quality Control

### Check These Before Using Results

1. **HLA typing quality**: Verify OptiType objective score (should be >0.9)
2. **Number of predictions**: Very few predictions may indicate VCF issues
3. **Class I/II balance**: Expect more Class I candidates
4. **VAF distribution**: Higher VAF = more clonal variants

### Red Flags

- No HLA alleles detected → Check BAM quality
- Zero neoantigens → Check VCF content
- All candidates have low scores → Normal for some tumors
