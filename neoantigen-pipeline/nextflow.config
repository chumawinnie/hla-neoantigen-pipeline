/*
========================================================================================
    NEOANTIGEN PIPELINE - NEXTFLOW CONFIG
========================================================================================
*/

// Global defaults
params {
    // Input/Output
    input                   = null
    outdir                  = './results'
    tracedir                = "${params.outdir}/pipeline_info"
    
    // Reference genome
    genome                  = 'GRCh38'
    
    // VEP settings
    vep_cache               = null
    vep_species             = 'homo_sapiens'
    vep_assembly            = 'GRCh38'
    vep_cache_version       = 110
    
    // HLA typing
    hla_reference           = null
    optitype_data           = null
    
    // pVACtools settings
    epitope_lengths_class1  = '8,9,10,11'
    epitope_lengths_class2  = '15'
    binding_threshold       = 500
    percentile_threshold    = 2
    top_score_metric        = 'lowest'
    net_chop_method         = 'cterm'
    netmhc_stab             = false
    
    // Filtering
    min_vaf                 = 0.05
    min_depth               = 10
    min_alt_reads           = 4
    
    // NetMHCpan paths (set via environment or params)
    netmhcpan_path          = null
    netmhciipan_path        = null
    
    // Resource limits
    max_cpus                = 16
    max_memory              = '128.GB'
    max_time                = '72.h'
    
    // Boilerplate
    help                    = false
    version                 = false
    publish_dir_mode        = 'copy'
    monochrome_logs         = false
}

/*
========================================================================================
    RESOURCE CONFIGURATION
========================================================================================
*/

process {
    // Default resources
    cpus   = { check_max( 2 * task.attempt, 'cpus' ) }
    memory = { check_max( 8.GB * task.attempt, 'memory' ) }
    time   = { check_max( 4.h * task.attempt, 'time' ) }

    errorStrategy = { task.exitStatus in [140,143,137,104,134,139] ? 'retry' : 'finish' }
    maxRetries    = 2
    maxErrors     = '-1'

    // Process-specific resources
    withName: 'EXTRACT_HLA_READS' {
        cpus   = { check_max( 4, 'cpus' ) }
        memory = { check_max( 16.GB, 'memory' ) }
        time   = { check_max( 2.h, 'time' ) }
    }

    withName: 'OPTITYPE' {
        cpus   = { check_max( 8, 'cpus' ) }
        memory = { check_max( 32.GB, 'memory' ) }
        time   = { check_max( 4.h, 'time' ) }
    }

    withName: 'HLA_HD' {
        cpus   = { check_max( 8, 'cpus' ) }
        memory = { check_max( 32.GB, 'memory' ) }
        time   = { check_max( 6.h, 'time' ) }
    }

    withName: 'VEP_ANNOTATE' {
        cpus   = { check_max( 4, 'cpus' ) }
        memory = { check_max( 16.GB, 'memory' ) }
        time   = { check_max( 2.h, 'time' ) }
    }

    withName: 'PVACSEQ' {
        cpus   = { check_max( 8, 'cpus' ) }
        memory = { check_max( 32.GB, 'memory' ) }
        time   = { check_max( 12.h, 'time' ) }
    }

    withName: 'FILTER_NEOANTIGENS' {
        cpus   = { check_max( 2, 'cpus' ) }
        memory = { check_max( 8.GB, 'memory' ) }
        time   = { check_max( 1.h, 'time' ) }
    }

    withName: 'GENERATE_REPORT' {
        cpus   = { check_max( 2, 'cpus' ) }
        memory = { check_max( 8.GB, 'memory' ) }
        time   = { check_max( 1.h, 'time' ) }
    }
}

/*
========================================================================================
    PROFILES
========================================================================================
*/

profiles {
    debug {
        process.beforeScript = 'echo $HOSTNAME'
        cleanup = false
    }
    
    docker {
        docker.enabled         = true
        docker.userEmulation   = true
        singularity.enabled    = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        
        process {
            withName: 'EXTRACT_HLA_READS' {
                container = 'quay.io/biocontainers/samtools:1.18--h50ea8bc_1'
            }
            withName: 'OPTITYPE' {
                container = 'fred2/optitype:1.3.5'
            }
            withName: 'HLA_HD' {
                container = 'ghcr.io/your-org/hla-hd:1.7.0'  // Custom build needed
            }
            withName: 'VEP_ANNOTATE' {
                container = 'ensemblorg/ensembl-vep:release_110.1'
            }
            withName: 'PVACSEQ' {
                container = 'griffithlab/pvactools:4.1.1'
            }
            withName: 'FILTER_NEOANTIGENS' {
                container = 'python:3.11-slim'
            }
            withName: 'GENERATE_REPORT' {
                container = 'ghcr.io/your-org/neoantigen-report:latest'  // Custom build
            }
            withName: 'MULTIQC' {
                container = 'quay.io/biocontainers/multiqc:1.19--pyhdfd78af_0'
            }
        }
    }
    
    singularity {
        singularity.enabled    = true
        singularity.autoMounts = true
        docker.enabled         = false
        podman.enabled         = false
        shifter.enabled        = false
        charliecloud.enabled   = false
        
        process {
            withName: 'EXTRACT_HLA_READS' {
                container = 'https://depot.galaxyproject.org/singularity/samtools:1.18--h50ea8bc_1'
            }
            withName: 'OPTITYPE' {
                container = 'docker://fred2/optitype:1.3.5'
            }
            withName: 'HLA_HD' {
                container = '/path/to/hla-hd_1.7.0.sif'  // Local SIF needed
            }
            withName: 'VEP_ANNOTATE' {
                container = 'docker://ensemblorg/ensembl-vep:release_110.1'
            }
            withName: 'PVACSEQ' {
                container = 'docker://griffithlab/pvactools:4.1.1'
            }
            withName: 'FILTER_NEOANTIGENS' {
                container = 'docker://python:3.11-slim'
            }
            withName: 'GENERATE_REPORT' {
                container = '/path/to/neoantigen-report.sif'  // Custom build
            }
            withName: 'MULTIQC' {
                container = 'https://depot.galaxyproject.org/singularity/multiqc:1.19--pyhdfd78af_0'
            }
        }
    }
    
    // Institution-specific profile (customize for Augsburg)
    augsburg {
        params {
            max_cpus   = 32
            max_memory = '256.GB'
            max_time   = '168.h'
        }
        
        executor {
            name = 'slurm'
            queueSize = 50
            submitRateLimit = '10 sec'
        }
        
        process {
            executor = 'slurm'
            queue = 'batch'
            clusterOptions = '--account=bioinformatics'
        }
    }
    
    test {
        params {
            max_cpus   = 2
            max_memory = '6.GB'
            max_time   = '6.h'
            input      = 'test/samplesheet.csv'
        }
    }
}

/*
========================================================================================
    EXECUTOR SETTINGS
========================================================================================
*/

executor {
    $local {
        cpus   = params.max_cpus
        memory = params.max_memory
    }
    $slurm {
        queueSize       = 100
        submitRateLimit = '10 sec'
    }
}

/*
========================================================================================
    CAPTURE REPORTS
========================================================================================
*/

def trace_timestamp = new java.util.Date().format('yyyy-MM-dd_HH-mm-ss')

timeline {
    enabled = true
    file    = "${params.tracedir}/execution_timeline_${trace_timestamp}.html"
}

report {
    enabled = true
    file    = "${params.tracedir}/execution_report_${trace_timestamp}.html"
}

trace {
    enabled = true
    file    = "${params.tracedir}/execution_trace_${trace_timestamp}.txt"
}

dag {
    enabled = true
    file    = "${params.tracedir}/pipeline_dag_${trace_timestamp}.svg"
}

/*
========================================================================================
    MANIFEST
========================================================================================
*/

manifest {
    name            = 'neoantigen-pipeline'
    author          = 'Bioinformatics Core Facility'
    homePage        = 'https://github.com/your-org/neoantigen-pipeline'
    description     = 'Nextflow pipeline for HLA typing and neoantigen prediction'
    mainScript      = 'main.nf'
    nextflowVersion = '!>=23.04.0'
    version         = '1.0.0'
}

/*
========================================================================================
    HELPER FUNCTIONS
========================================================================================
*/

def check_max(obj, type) {
    if (type == 'memory') {
        try {
            if (obj.compareTo(params.max_memory as nextflow.util.MemoryUnit) == 1)
                return params.max_memory as nextflow.util.MemoryUnit
            else
                return obj
        } catch (all) {
            println "WARNING: Max memory '${params.max_memory}' is not valid, using default"
            return obj
        }
    } else if (type == 'time') {
        try {
            if (obj.compareTo(params.max_time as nextflow.util.Duration) == 1)
                return params.max_time as nextflow.util.Duration
            else
                return obj
        } catch (all) {
            println "WARNING: Max time '${params.max_time}' is not valid, using default"
            return obj
        }
    } else if (type == 'cpus') {
        try {
            return Math.min( obj, params.max_cpus as int )
        } catch (all) {
            println "WARNING: Max cpus '${params.max_cpus}' is not valid, using default"
            return obj
        }
    }
}
